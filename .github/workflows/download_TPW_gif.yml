name: Download and Create GIF

on:
  schedule:
    - cron: '5 * * * *'  # æ¯å°æ—¶çš„ç¬¬5åˆ†é’Ÿè¿è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Install ImageMagick for GIF creation
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick

    - name: Create necessary directories
      run: |
        # åˆ›å»ºå›¾ç‰‡ç›®å½•
        mkdir -p images/history
        mkdir -p images/gif

    - name: Download latest image
      run: |
        timestamp=$(date -u +"%Y%m%d_%H00")  # ç²¾ç¡®åˆ°å°æ—¶
        hour=$(date -u +"%H")
        
        # ä¸‹è½½æœ€æ–°å›¾ç‰‡
        curl -s -f -L -o "images/history/image_${timestamp}.png" \
          "https://bin.ssec.wisc.edu/pub/mtpw2/images/tpw_nrl_colors/global2_latest/latest_image.png"
        
        # åŒæ—¶ä¿å­˜ä¸ºæœ€æ–°å›¾ç‰‡
        cp "images/history/image_${timestamp}.png" "images/latest.png"
        
        if [ $? -ne 0 ] || [ ! -s "images/history/image_${timestamp}.png" ]; then
          echo "âŒ å›¾ç‰‡ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        echo "âœ… å›¾ç‰‡ä¸‹è½½æˆåŠŸ: image_${timestamp}.png"

    - name: Clean old images (keep only last 24)
      run: |
        cd images/history
        
        # è·å–æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶ï¼ŒæŒ‰æ–‡ä»¶åæ’åºï¼ˆæ—¶é—´é¡ºåºï¼‰
        # ä¿ç•™æœ€è¿‘çš„24ä¸ªæ–‡ä»¶
        file_count=$(ls image_*.png 2>/dev/null | wc -l)
        
        if [ $file_count -gt 24 ]; then
          # æŒ‰æ–‡ä»¶åæ’åºï¼Œåˆ é™¤æœ€æ—§çš„
          files_to_delete=$(ls image_*.png | sort | head -n $((file_count - 24)))
          echo "åˆ é™¤æ—§æ–‡ä»¶:"
          echo "$files_to_delete"
          rm -f $files_to_delete
        elif [ $file_count -eq 0 ]; then
          echo "æ²¡æœ‰å†å²å›¾ç‰‡æ–‡ä»¶"
        else
          echo "å½“å‰æœ‰ $file_count ä¸ªå†å²å›¾ç‰‡æ–‡ä»¶"
        fi

    - name: Create GIF from last 24 images
      run: |
        cd images/history
        
        # æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å›¾ç‰‡åˆ›å»ºGIF
        file_count=$(ls image_*.png 2>/dev/null | wc -l)
        
        if [ $file_count -ge 2 ]; then  # è‡³å°‘æœ‰2å¼ å›¾ç‰‡æ‰èƒ½åˆ›å»ºGIF
          # æŒ‰æ—¶é—´é¡ºåºæ’åˆ—å›¾ç‰‡
          files=$(ls image_*.png | sort)
          
          # åˆ›å»ºGIFï¼Œæ¯å¸§å»¶è¿Ÿ100æ¯«ç§’ï¼ˆ0.1ç§’ï¼‰ï¼Œå¾ªç¯æ’­æ”¾
          # ä½¿ç”¨-resizeè°ƒæ•´å¤§å°ï¼Œé¿å…GIFè¿‡å¤§
          echo "æ­£åœ¨åˆ›å»ºGIFåŠ¨ç”»..."
          convert -delay 100 -loop 0 -resize 800x600 $files ../gif/animation.gif
          
          # åŒæ—¶åˆ›å»ºä¸€ä¸ªæ›´å¿«çš„ç‰ˆæœ¬
          convert -delay 50 -loop 0 -resize 800x600 $files ../gif/animation_fast.gif
          
          echo "âœ… GIFåŠ¨ç”»åˆ›å»ºæˆåŠŸ"
          echo "å·²ä¿å­˜æ–‡ä»¶: animation.gif (100ms/å¸§), animation_fast.gif (50ms/å¸§)"
        else
          echo "âš ï¸ å›¾ç‰‡æ•°é‡ä¸è¶³ï¼ˆå½“å‰$file_countå¼ ï¼‰ï¼Œæ— æ³•åˆ›å»ºGIF"
          # åˆ›å»ºç©ºGIFæˆ–å ä½æ–‡ä»¶
          echo "GIF creation pending..." > ../gif/placeholder.txt
        fi

    - name: Create timestamp file
      run: |
        # åˆ›å»ºæ—¶é—´æˆ³æ–‡ä»¶ï¼Œè®°å½•æ›´æ–°æ—¶é—´
        echo "æœ€åæ›´æ–°æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" > images/update_info.txt
        echo "å†å²å›¾ç‰‡æ•°é‡: $(ls images/history/image_*.png 2>/dev/null | wc -l)" >> images/update_info.txt
        echo "GIFå¸§æ•°: $(ls images/history/image_*.png 2>/dev/null | wc -l)" >> images/update_info.txt
        echo "ä¸‹æ¬¡æ›´æ–°: æ¯å°æ—¶çš„ç¬¬5åˆ†é’Ÿ" >> images/update_info.txt

    - name: Commit and push changes
      run: |
        # æ‹‰å–æœ€æ–°æ›´æ”¹é¿å…å†²çª
        git pull origin main --rebase || true
        
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
        git add images/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          # è·å–å†å²å›¾ç‰‡æ•°é‡
          img_count=$(ls images/history/image_*.png 2>/dev/null | wc -l)
          
          # æäº¤ä¿¡æ¯
          commit_msg="ğŸ”„ æ›´æ–°å›¾ç‰‡ ($(date -u +'%H:%M UTC'))"
          if [ $img_count -ge 2 ]; then
            commit_msg="$commit_msg | GIFåŠ¨ç”»å·²æ›´æ–° ($img_countå¸§)"
          fi
          
          git commit -m "$commit_msg"
          git push
          echo "âœ… å·²æˆåŠŸæ¨é€æ›´æ”¹"
        fi
